# Проектирование высоконагруженного пространства для командной работы
Курсовая работа в рамках 3-го семестра программы по Веб-разработке ОЦ VK x МГТУ им. Н.Э. Баумана (ex. "Технопарк") по дисциплине "Проектирование высоконагруженных сервисов"

__Автор__ - [AlfaIV](https://github.com/alfaiv)</br>
__Задание__ - [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)</br>
__[Таблица отчетности](https://vk.com/away.php?to=https%3A%2F%2Fdocs.google.com%2Fspreadsheets%2Fd%2F1XhRgeQARIXGoiTSYQStW4GTlXJ62-jgL36c2i8HvYJ4%2Fedit%3Fusp%3Dsharing&cc_key=)__

## Содержание

- [1. Функционал и продуктовые метрики](#chapter-one)
- [2. Расчет нагрузки](#chapter-two)
- [3. Глобальная балансировка нагрузки](#chapter-tree)
- [4. Локальная балансировка нагрузки](#chapter-four)
- [6. Физическая схема БД](#chapter-six)
- [7. Алгоритмы](#chapter-seven)
- [8. Технологии](#chapter-eight)
- [Используемые источники](#sorce)

## 1. Функционал и продуктовые метрики
<a id="chapter-one"></a>

__Функциональные возможности__ - это поисковая система. Она позволяет пользователям искать информацию в интернете, включая веб-страницы, изображения, видео, новости и другие типы контента.

__Целевая аудитория__ - в результате исследования данной темы, конкретного количества пользователей поисковый системы Яндекс не было найдено. Поэтому использовалась следующая логика. В основном аудитория данного сервиса - _русскоязычные пользователи интернета_ - рунет. [Согласно статистике](https://www.web-canape.ru/business/statistika-interneta-i-socsetej-na-2023-god-cifry-i-trendy-v-mire-i-v-rossii/) в России 127.6 миллионов пользователей Интернета. Согласно сервису [Яндекс Радар](https://radar.yandex.ru/search?period=all&selected_rows=iHMJ0E%252CvDPqTi%252C8fg2y0%252Ctmkupd%252CMCj1FA) пользователи Яндекса составляют 64.25% от общего числа пользователей поисковых систем. Таким образом, можно предположить, что количество пользователей составляет ``127.6E6*0.64 = 76E6``.</br>

Ниже представлена таблица, показывающая долю пользователей Яндекс из разных стран:

 Страна         |  Процент пользователей Яндекс поиска
----------------|------------------------
 Россия         |   95.04%
 Украина        |    0.89%
 Беларусь       |    0.66%
 Нидерланды     |    0.27%
 Молдова        |    0.27%
 Другие         |    2.87%

Для определения метрик DAU и MAU возьмем данные с сайта [HypeStat](https://hypestat.com/info/ya.ru):

- количество пользователей ~ 81,66M
- MAU ~ 44,9M
- DAU ~ 15,8M

__Ключевой функционал:__

- Регистрация и авторизация
- Поиск веб-страниц
- История поиска

## 2. Расчет нагрузки
<a id="chapter-two"></a>

__Продуктовые метрики__

Среднее количество действий пользователя можно оценить следующим образом. Т.к. данный сервис представляет собой поисковую систему, то вероятнее всего, что в общем случае сценарий использования сервиса следующий: пользователей заходит на главную поисковую страницу, набирает запрос и пользуется пагинатором. Согласно [5] страниц за визит 5,8 значит 3-4 перехода пользователь проводит за сеанс использования ресурса.</br>

Прикинем размер истории пользователя. Допустим, символы в истории пользователя кодируются UTF-8, тогда размер символа - 1 байт. 2 000 символов - максимальный размер URL адреса. _По собственному опыту_ ежедневного использования браузера, имею порядка 100 000 записей в истории. Таким образом, ``1 байт *2 000 символов * 100 000 записей = 200Гб``. Предположим, что история сжимается каким-либо алгоритмом, в среднем на 40%. Таким образом, получим следующий результат ``200Гб * (1 - 0.4) = 120Гб``

Таким образом, имеем следующие продуктовые метрики:

 Продуктовая метрика                      |Значение
------------------------------------------|--------
 MAU                                      | 44,9М  
 DAU                                      | 15,8М
 Средний размер страницы                  | 0.3 Мб
 Количество заходов на сайт за месяц      | 500M
 Записи истории пользователя              | 100 000 записей

Оценка объема страницы яндекс поиска.
![Размер стартовой страницы](img/yandex.png)
![Размер поисковой страницы](img/search2.png)
![Размер поисковой страницы](img/search3.png)

__Технические метрики__

При загрузке страницы ya.ru инструменты разработчика показали, размер страницы в среднем 0.3 Мб, получим трафик на одного пользователя. Умножив это значение на DAU, получим _суммарный суточный трафик_. Однако, учтем, что страницы у пользователя кешируются, поэтому значительным будет трафик получаемый уникальным пользователем (первая страница), далее они значительно снижается.</br>
_Пиковый трафик_ определим, как усредненный суточный с небольшим коэффициентом, например 1.5</br>
_RPS на авторизацию_ найдем из из следующих соображений соображений, поделим DAU на секунды в дне.<br>
При расчете сетевого трафика не будем учитывать запросы, связанные с _регистрацией пользователей_, так как они не создают ощутимую нагрузку на сервис. Основная нагрузка приходится на запросы к поисковой системе.

 Техническая метрика                             |Значение
-------------------------------------------------|------------------------
 Пиковое потребление трафика в течении суток     | 0.7 Гбит/с
 Суммарный суточный трафик                       | 4 970.3 Гбайт/сутки
 RPS (авторизация)                               | 183 запросов в секунду
 RPS                                             | 5 788 запросов в секунду
 Суммарный объем данных [11] *                   | 50 Пб
 Размер индекса [8]                              | 250 ТБ
 Размер истории пользователя                     | 120Гб

*Суммарный объем данных включает в себя и реплику и индексы.

## 3. Глобальная балансировка нагрузки
<a id="chapter-tree"></a>

Исходя из данных, представленных в первом пункте курсовой работы, можно сделать вывод, что нужно расположить большую часть датацентров в Росиии.<br>

Так как население России распределено неравномерно, нам потребуются расположить основную часть датацентров в европейской части страны[14].<br>

![плотность населения России](https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Federal_subjects_of_Russia_by_population_dencity.svg/1920px-Federal_subjects_of_Russia_by_population_dencity.svg.png)

Следовательно, были выбраны следующие города для установки датацентров:

- Москва
- Владимир
- Рязань

Также имеет смысл разместить сервера на Украине, например в Киеве (без учета текущей ситуации). Таким образом, можно улучшить качество предоставляемых услуг для жителей Украины, Молдовы, Белоруссии и южных регионов России.</br>

Таким образом, можно составить следующую карту датацентров: [карта датацентов](https://yandex.ru/maps/?um=constructor%3A1a245cfdfa0b8edad4e6334f166dc8c5658ea634ecf4b590220d70426b31da7d&source=constructorLink)

Для __глобальной балансировки запросов и нагрузки__ будем использовать:

- Применим latency-based DNS , так как он позволяет эффективно распределять траффик по RTT к ближайшим серверам

## 4. Локальная балансировка нагрузки
<a id="#chapter-four"></a>

__Kubernetes__
Kubernetes решает проблему отказоустойчивости в рамках сервисов. Он предоставляет механизмы для автоматического перезапуска контейнеров в случае их сбоя и обеспечивает механизмы для обнаружения и восстановления. Это позволяет быстро восстанавливать работоспособность сервисов и минимизировать простои.

__BGP/RIP балансировка__
Для распределения данных на балансировщик L3 будет использоваться BGP маршрутизация.

__L7 балансировщик__
Для балансировки запросов на сервисы, поднятые в подах Kubernetes, будет использоваться Nginx с помощью Weighted Least Connections.

__SSL termination__
Для снятия нагрузки с серверов по расшифровке SSL будет использоваться SSL Termination, который будет выполняться L7 балансировщиком.
Для кеширования сессии будет использоваться механизм Session cache.

## 5. Логическая схема БД
<a id="#chapter-five"></a>

__Структура базы данных__

Ниже представлены таблицы, поля и связи между ними без привязки к конкретным базам и шардингу.

![Структура БД](img/DBchart.drawio.svg)

Описание таблицы

 Таблица | Описание
---------|--------------------------------
 Users   | Хранение данных о пользователе
 History | История пользователя
 Session | Сессии пользователей
 Indexes | Поисковые индексы
 Content | Закешированные страницы
 Hint    | Поисковые подсказки
 Plan    | Последовательность URL для обхода поисковым ботом

__Размер данных__

Оценку размеров таблиц БД проведем согласно проведенным ранее в пункте 2 расчетам.

  Таблица | Описание
---------|--------------------------------
 History | 120 Гб
 Indexes | 250 Тб
 Content | 50 Пб

__Нагрузска на запись/чтение__

Воспользуемся данными, полученными из 2 раздела.</br>
Для таблицы _Users_ запросы на чтение примем как запросы на авторизацию, запросы на запись примем равными 5.</br>
Для таблиц _History_ запросы на чтение примем рассчитаем следующим образом, предположим, что история пользователя синхронизируется (как пишеться, так и считывается) 1 раз в день. Таким образом, количество запросов равной количеству запросов на авторизацию.</br>
Для таблиц _Index и Pages_ запросы на чтение примем как запросы на поиск (обращение к сервису), запросы на запись примем равными .</br>

 Таблица       | Чтение                     | Запись
---------------|----------------------------|----------------------------
 Users         | 183 запросов в секунду     | 5 запросов в секунду  
 History       | 183 запросов в секунду     | 183 запросов в секунду  
 Indexes       | 5 788 запросов в секунду   | 20 000 запросов в секунду на ноду ES
 Content       | 5 788 запросов в секунду   | 20 000 запросов в секунду на ноду

## 6. Физическая схема БД
<a id="#chapter-six"></a>

__Шардинг__
Шардинг является основой построения системы так, как хранимое количество данных очень велико и физически не уместиться на 1ой СХД. Поэтому индекс и слепок интернета равномерно распределиться по датацентарам, учитывая ранее приведенное расположение датацентров.

__Репликация__
Реплицировать имеет смысл только индекс и данные пользователей. Потеря реплики интернета не приведет к существенным проблемам так, как это слепок сети несет лишь вспомогательную функцию.

__Индексы__
Индексирование подразумевает сам механизм работы поисковой системы (для этого создается отдельная БД).

__Денормализация__
Не имеет смысла так, как размер основных таблиц данных (индексы и архив интернета) очень большой и нет необходимости укрупнять его дополнительно.

## 7. Алгоритмы
<a id="#chapter-seven"></a>

_Суть поисковой системы состоит в следующем:_ с одной стороны происходит переодический обход всего интернета для составления индекса (специальной БД для сопоставления URL и поискового слова), с другой формирование ответов на запросы пользователей к индексу, например 10 URL адресов подобранных по определенному множеству предположений относительно смысла запроса.</br>

Подготовка данных, по которым ищет поисковая машина, называется индексированием. Специальная компьютерная система — поисковый робот — регулярно обходит интернет, выкачивает документы и обрабатывает их. Создается своего рода слепок интернета, который хранится на серверах поисковика и обновляется при каждом новом обходе.</br>

__Рассмотрим работу поискового робота:__
Чаще всего работают два поисковых робота — основной и быстрый. Основной робот индексирует интернет в целом, а быстрый отвечает за то, чтобы в поиске можно было найти самые свежие документы. У каждого робота есть список адресов документов, которые нужно проиндексировать.</br>

Сначала программа-планировщик выстраивает маршрут — очередность обхода документов. После создания маршрута планировщик отдаёт его другой части поискового робота — «пауку». Паук регулярно обходит документы по заданному маршруту, а затем отправляет данные в хранилище.</br>

Там программа разбирает документ на слова и добавляет их в индекс. Сам документ в исходном виде также остается в хранилище до следующего обхода. Благодаря этому пользователи могут найти и посмотреть документы, даже если сайт временно недоступен. Если сайт закрылся или документ был удалён или обновлён, копия удаляется с серверов или заменяется на новую.<br>

__Рассмотрим алгоритм обработки ответа:__
Все пользовательские запросы сначала попадают в компьютерную систему «метапоиск». Метапоиск обрабатывает каждый запрос в реальном времени — выясняет все необходимые данные про запрос (из какого региона он был задан, к какому классу относится и т.п.), проводит лингвистическую обработку. Затем метапоиск проверяет, формировались ли в последнее время результаты поиска для этого запроса. Если вновь пришедший запрос оказался популярным, метапоиск покажет пользователю заранее сохраненные результаты.<br>

Если же ответа в памяти нет, то метапоиск передаёт запрос на сервера «базового поиска». На базовом поиске хранится слепок интернета, по которому ищет поисковая система — поисковая база. Она разбита на части, которые хранятся на разных серверах — искать ответ одновременно по нескольким частям базы данных быстрее, чем по всей базе целиком. Кроме того, у каждого сервера есть несколько копий. Это позволяет распределять нагрузку и не терять данные — если один из серверов не сможет своевременно ответить, информация всё равно найдется на дублирующих серверах. Из тысяч серверов базового поиска метапоиск выбирает наименее загруженные – таким образом, чтобы вместе они содержали целую поисковую базу.<br>

__В основе алгоритма ответов на поисковые запросы__ лежит ML технология классификации запросов, выделяет около 60 категорий. Знание категорий позволяет поисковой системе различать разные значения слов в поисковых запросах.
Кроме того, учитываються при поиске различные потребности пользователей. У каждой категории есть список возможных потребностей — тех намерений, с которыми пользователи ищут тот или иной объект, например слово "купить". Всего у категории может быть от двух-трех до нескольких десятков потребностей.<br>

С учетом того, в какие категории попал объект, оценивается процент людей, которые ищут этот объект с каждой из возможных целей. Эти данные используются при ранжировании результатов поиска по многозначным запросам. Используя их, вычисляется пропорции, в которых ответы на ту или иную тему должны быть представлены в результатах поиска. Найденные сайты упорядочиваются таким образом, чтобы спектр ответов соответствовал спектру вопросов. Анализируются запросы автоматически и постоянно.</br>

## 8. Технологии
<a id="#chapter-eight"></a>

 Технология       | Область применения           | Мотивационная часть
------------------|------------------------------|---------------------------
 Go               | Backend                      | современный, простой, удобная многопоточность
 React, Redux     | Frontend                     | удобные, популярные фреймворки
 Nginx            |	балансировщик                | скорость, надежность
 Redis            | сессии                       | быстрое key-value БД
 ElasticSearch    | БД: история, индексы, подсказки  | удобная БД для текстового поиска по большим объемам
 YTsaurus         | БД: интернет, маршрут обхода     | перспективная реализация MapRedus
 Posgres          | БД пользователи, история поиска  | самая популярная БД
## Используемые источники
<a id="sorce"></a>

1. [Статистика пользователей интернета](https://www.web-canape.ru/business/statistika-interneta-i-socsetej-na-2023-god-cifry-i-trendy-v-mire-i-v-rossii/)
1. [Яндекс инвесторам](https://ir.yandex.ru/)
1. [Яндекс Радар](https://radar.yandex.ru/search?period=all&selected_rows=iHMJ0E%252CvDPqTi%252C8fg2y0%252Ctmkupd%252CMCj1FA)
1. [Be1.ru](https://be1.ru/stat/ya.ru)
1. [SpyMetrics](https://spymetrics.ru/ru/website/ya.ru)
1. [HypeStat](https://hypestat.com/info/ya.ru)
1. [similarweb](https://www.similarweb.com/website/ya.ru/)
1. [Архитектура Поиска Яндекса](https://habr.com/ru/companies/yandex/articles/204282/)
1. [Что-то про БД](https://habr.com/ru/articles/123884/)
1. [Технологии Яндекса](https://yandex.ru/company/technologies/)
1. [Доклад про Яндекс](https://habr.com/ru/companies/yandex/articles/312716/)
1. [Что-то про поиск](https://habr.com/ru/companies/hh/articles/413261/)
1. [Статистика](https://datareportal.com/search?q=DIGITAL%202023%3A%20Rus)
1. [Контент Рунета](https://yandex.ru/company/researches/2009/ya_content_09/)
1. [Статистика по Яндексу](https://inclient.ru/yandex-stats/)
1. [Плотность населения России](https://ru.wikipedia.org/wiki/Плотность_населения_субъектов_Российской_Федерации)
1. [Инфраструктура Яндекса](https://www.tadviser.ru/index.php/Статья:Яндекс_(ИТ-инфраструктура))
1. [Конструктор Карт](https://yandex.ru/map-constructor/)
1. [Количество доменов РУ](https://www.kommersant.ru/doc/5773611?tg)

#### Дополнительно

https://habr.com/ru/companies/vk/articles/149498/
https://xakep.ru/2014/01/11/big-data-secrets/
https://habr.com/ru/companies/hh/articles/413261/
[Яндекс MapReduce](https://habr.com/ru/companies/yandex/articles/311104/)
[Про mail поиск](https://habr.com/ru/companies/vk/articles/167297/)
